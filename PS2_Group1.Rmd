---
title: "Report for PS 2"
author:
- Mark Becker, Erik Lillrank & Vilim Nedic
date: ''
output:
  pdf_document:
    keep_tex: true
  df_print: kable
  html_document:
    df_print: paged
  word_document: default
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{multirow}
  - \usepackage{caption}
  - \usepackage{subcaption}
  - \usepackage{adjustbox}
toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(FE)
library(knitr)
library(forecast)
library(patchwork)
library(kableExtra)
library(dplyr)
library(purrr)
data("DJ_w")
data("DJ_d")
data("portcap_m")
```

# A. Testing for asset return predicatability.
Use the data sets ”DJ_d” (Dow Jones daily) and ”DJ_w” (Dow Jones weekly) containing daily and weekly observations of the Dow Jones index. In the following, you have to test for asset return predictability based on autocorrelation functions, Ljung-Box statistics as well as variance ratio tests.

## 1. Do you find significant evidence for asset return predictability on the daily and weekly level?

For this question, we will use autocorrelation functions, Lung-Box statistics and variance ratio tests in order to gage whether there is significant evidence for asset return predictability.

ACF: 
```{r A1_ACF, echo=F}
par(mfrow=c(1,2))
p1 <- Acf(DJ_d$r_Dow_Jones, lag.max = 20, main = "Dow Jones daily")
p2 <- Acf(DJ_w$r_close, lag.max = 20, main = "Dow Jones weekly")
par(mfrow=c(1,1))
```
Above you see the ACF plots for the Dow Jones daily and weekly data with 20 lags. For easier interpretation, lag 0 has been omitted.

What we see from the plots is that we have large spikes for the first two lags in the daily data, with some moderately large spikes for further lags. For the weekly data we essentially only see 1 (barely) significant spike, but it can definately be due to randomness, since we can expect 1 in 20 to be significant because of the 5% level blue bands. 

So because we see significant auto-correlations for the first few lags in the daily data, this is an indication of asset return predictability, at least short-term.


Ljung-Box test:

```{r A1_LB, include=F}
LB <- function(vx,lag,ip){
  tmp = acf(vx,lag.max=lag,plot=F)$acf
  tmp = tmp[2:(lag+1)]**2
  test = sum(tmp/(length(vx)-1:lag))*length(vx)*(length(vx)+2)
  return(list(test=test, pval=1-pchisq(test,df=lag-ip)))
}

gridsearch <- function(data, lag){
  results <- matrix(NA, nrow=length(lag), ncol = 2)
  for (j in 1:length(lag)){
      lagj <- lag[j]
      results[j,1]<-LB(vx=data,lag=lagj,ip=0)$test
      results[j,2]<-LB(vx=data,lag=lagj,ip=0)$pval
    }
  return(results)
}
lag = c(5,10,20)
t1 <- gridsearch(DJ_d$r_Dow_Jones, lag)
t2 <- gridsearch(DJ_w$r_close, lag)
cbind(t1,t2)
```
\begin{table}[ht]
\centering
\caption{Ljung-Box Test Statistics for Dow Jones Daily and Weekly Returns (Rounded to 3 Decimal Places)}
\label{tab1:LB}
\begin{tabular}{lcccc}
\toprule
\multirow{2}{*}{Lag} & \multicolumn{2}{c}{Dow Jones Daily} & \multicolumn{2}{c}{Dow Jones Weekly} \\ 
\cmidrule(lr){2-3} \cmidrule(lr){4-5}
 & $Q_{LB}$ & p-value & $Q_{LB}$ & p-value \\ 
\midrule
5  & 329.899 & 0.000 & 5.144 & 0.399 \\ 
10  & 371.600 & 0.000 & 13.592 & 0.192 \\ 
20  & 388.925 & 0.000 & 23.320 & 0.273 \\ 
\bottomrule
\end{tabular}
\end{table}

So we now test the nulls that the first 5, 10 and 20 autocorrelations are all zero. We see from table \ref{tab1:LB} that the p-values for 5, 10, and 20 lags are zero for the daily data, meaning that we have significant auto-correlations. This is an indication that there is potentially asset return predictability in the daily data. For the weekly series, all p-values are above $\alpha=0.1$. Using $\alpha=0.1$ we reject the null that there is auto-correlation in the weekly data, indicating that there is no prevalence of asset return predictability. 

Variance ratio test:

```{r A1_VR, include=F}
VDR <- function(vr,iq){
  iTT = length(vr)
  im = floor(iTT/iq)
  iT = im*iq
  
  rr = vr[1:iT]
  mu = mean(rr)
  sa2 = var(rr)
  
  arr = NULL
  for(iter in 1:(iT-iq+1))
    arr = c(arr,sum(rr[iter:(iter+iq-1)]))
  
  sc2 = sum((arr-mu*iq)**2)/iq/(iT-iq+1)/(1-(1/im))
  
  VD = sc2 - sa2
  VR = sc2/sa2
  tmp = sqrt(2*(2*iq-1)*(iq-1)/3/iq)
  
  VD = VD*sqrt(iT)/sa2/tmp
  VR = (VR-1)*sqrt(iT)/tmp
  
  RW1_p_VD <- 2*(1-pnorm(abs(VD)))
  RW1_p_VR <- 2*(1-pnorm(abs(VR)))
  
  return(list(VD=VD, VR=VR, RW1_p_VD=RW1_p_VD, RW1_p_VR=RW1_p_VR))
}
q <- c(2,4,8,16)
res_d <- matrix(NA, nrow=4, ncol=4)
res_w <- matrix(NA, nrow=4, ncol=4)

for (i in 1:length(q)){
res_1 <- VDR(vr=DJ_d$r_Dow_Jones,iq=q[i])
res_2 <- VDR(vr=DJ_w$r_close,iq=q[i])
res_d[i,1] <- res_1$VD
res_d[i,2] <- res_1$RW1_p_VD
res_d[i,3] <- res_1$VR
res_d[i,4] <- res_1$RW1_p_VR
res_w[i,1] <- res_2$VD
res_w[i,2] <- res_2$RW1_p_VD
res_w[i,3] <- res_2$VR
res_w[i,4] <- res_2$RW1_p_VR
}
cbind(round(res_d,3),round(res_w,3))
```
\begin{table}[ht]
\centering
\caption{The variance ratio test under RW1. Presented are variance distance, ratio, and p-values for Dow Jones daily and weekly data.}
\label{tab:VDR1}
\begin{tabular}{c|cccc|cccc}
\hline
\multicolumn{1}{c|}{} &
\multicolumn{4}{c|}{Dow Jones Daily} & \multicolumn{4}{c}{Dow Jones Weekly} \\ \hline
q & VD & p-value & VR & p-value & VD & p-value & VR & p-value \\ \hline
2 & 13.402 & 0.000 & 13.402 & 0.000 & -0.936 & 0.349 & -0.936 & 0.349 \\
4 & 5.642 & 0.000 & 5.642 & 0.000 & -0.489 & 0.625 & -0.489 & 0.625 \\
8 & 5.410 & 0.000 & 5.410 & 0.000 & 0.197 & 0.844 & 0.197 & 0.844 \\
16 & 5.359 & 0.000 & 5.359 & 0.000 & 0.574 & 0.566 & 0.574 & 0.566 \\
\hline
\end{tabular}
\end{table}

We now test the null of Random Walk returns, i.e. no predictability. For the daily series, the variance distance (VR) and ratio (VD) are above 1, indicating that we have positive auto-correlation. The p-values are zero for all $q$, indicating that we have significant evidence for asset return predictability. For the weekly series, VR and VD are below 1, indicating both positive and negative auto-covariance. However, looking at the p-values we see that the results are not statistically significant and we can therefore not reject the null. As such, we do not have evidence of asset return predictability for the weekly data.

## 2. What about the asset return predictability of two-day and two-week returns? What about the higher aggregated returns?

We create the annualized two-day and two-week returns like below.

```{r, echo=F}
oneday <- DJ_d$r_Dow_Jones
oneday <- oneday[-1] # remove first obs, otherwise below doesn't work
oneweek <- DJ_w$r_close

twoday <- oneday[seq(1, length(oneday), by = 2)] + oneday[seq(2, length(oneday), by = 2)]
twoday_ann <- twoday/2


twoweek <- oneweek[seq(1, length(oneweek), by = 2)] + oneweek[seq(2, length(oneweek), by = 2)]
twoweek_ann <- twoweek/2
```


```{r, echo=F}
par(mfrow=c(1,2))
ts.plot(twoday_ann)
ts.plot(twoweek_ann)
par(mfrow=c(1,1))

par(mfrow=c(1,2))
p3 <- Acf(twoday_ann, lag.max = 20, main = "DJ two day ann. log returns")
p4 <- Acf(twoweek_ann, lag.max = 20, main = "DJ two-week ann. log returns")
par(mfrow=c(1,1))
```

Above we can see ACF plots for the annualized two-day and two-week log returns with 20 lags. For easier interpretation, lag 0 has been omitted.

What we see from the first ACF plot for the two-day is that we have large significant spikes at lag 2 and 4, 11, 15 and 17. For the two-week data we see two significant spikes at 12 and 15, but they are not very large.

So for two-day we see significant auto-correlations for many lags, and quite far out also, this is an indication of asset return predictability. For two-week we see significant auto-correlations for two lags quite far out, this is an indication of asset return predictability.

But realistically using more than 10 lags for two week data does not make much sense. It is too many lags out for two-weekly data. So I think we can reasonably disregard this finding and say that it is due to randomness/noise. But for two-day we for sure see strong signs of market predictability.

Lets do Ljung Box tests, but restrict two-week to have lag=10.
```{r}
LB(twoday_ann, lag=20, ip=0)

LB(twoday_ann, lag=10, ip=0)
```
So the result tells us that for the two-day returns, that we strongly reject $(\alpha=0.01)$ the null of the first 20 autocorrelations being all zero. For the two-week returns, we strongly reject $(\alpha=0.01)$ the null of the first 10 autocorrelations being zero. The latter result is quite suprising since we did not see significant spikes at 10 lags or earlier for the two-week. These results strongly indicate that there is prevalence of asset return predictability for both two-day and two-week returns.

Variance ratio test:

```{r, include=F}
VDR <- function(vr,iq){
  iTT = length(vr)
  im = floor(iTT/iq)
  iT = im*iq
  
  rr = vr[1:iT]
  mu = mean(rr)
  sa2 = var(rr)
  
  arr = NULL
  for(iter in 1:(iT-iq+1))
    arr = c(arr,sum(rr[iter:(iter+iq-1)]))
  
  sc2 = sum((arr-mu*iq)**2)/iq/(iT-iq+1)/(1-(1/im))
  
  VD = sc2 - sa2
  VR = sc2/sa2
  tmp = sqrt(2*(2*iq-1)*(iq-1)/3/iq)
  
  VD = VD*sqrt(iT)/sa2/tmp
  VR = (VR-1)*sqrt(iT)/tmp
  
  RW1_p_VD <- 2*(1-pnorm(abs(VD)))
  RW1_p_VR <- 2*(1-pnorm(abs(VR)))
  
  return(list(VD=VD, VR=VR, RW1_p_VD=RW1_p_VD, RW1_p_VR=RW1_p_VR))
}

q <- c(2,4,8,16)
res_d <- matrix(NA, nrow=4, ncol=4)
res_w <- matrix(NA, nrow=4, ncol=4)

for (i in 1:length(q)){
res_1 <- VDR(vr=twoday_ann,iq=q[i])
res_2 <- VDR(vr=twoweek_ann,iq=q[i])
res_d[i,1] <- res_1$VD
res_d[i,2] <- res_1$RW1_p_VD
res_d[i,3] <- res_1$VR
res_d[i,4] <- res_1$RW1_p_VR
res_w[i,1] <- res_2$VD
res_w[i,2] <- res_2$RW1_p_VD
res_w[i,3] <- res_2$VR
res_w[i,4] <- res_2$RW1_p_VR
}
cbind(round(res_d,3),round(res_w,3))
```
\begin{table}[ht]
\centering
\caption{The variance ratio test under RW1. Presented are variance distance, ratio, and p-values for Dow jones two-day and two-week (annualized) log returns}
\label{tab:VDR2}
\begin{tabular}{c|cccc|cccc}
\hline
\multicolumn{1}{c|}{} &
\multicolumn{4}{c|}{Two-day} & \multicolumn{4}{c}{Two-week} \\ \hline
q & VD & p-value & VR & p-value & VD & p-value & VR & p-value \\ \hline
2 & -0.880 & 0.379 & -0.880 & 0.379 & -0.603 & 0.546 & -0.603 & 0.546 \\
4 & 2.068 & 0.039 & 2.068 & 0.039 & 0.324 & 0.746 & 0.324 & 0.746 \\
8 & 3.355 & 0.001 & 3.355 & 0.001 & 0.662 & 0.508 & 0.662 & 0.508 \\
16 & 3.070 & 0.002 & 3.070 & 0.002 & 1.487 & 0.137 & 1.487 & 0.137 \\
\hline
\end{tabular}
\end{table}

For the two-day series, the variance distance (VR) and ratio (VD) are below 1 for $q=2$ and above 1 for the rest, indicating that we have both positive and negative auto-covoriance. The p-values are <0.01 for all $q$ except $q=2$, indicating that we have some evidence for asset return predictability. For the two-week series, VR and VD are below 1 and above 1, indicating negative and positive auto-covariance. However, looking at the p-values we see that the results are not statistically significant and we can therefore not reject the null. As such, we do not have evidence of asset return predictability for the two-week data.



## 3. Divide the sample into appropriate sub-periods and analyze whether you find evidence of an increasing market efficiency over time.

```{r}
# Dividing the data set into three equally sized time windows 
djd_s1 <- DJ_d[1:6280, ]
djd_s2 <- DJ_d[6281:12560, ]
djd_s3 <- DJ_d[12561:18839, ]
djw_s1 <- DJ_w[1:1562, ]
djw_s2 <- DJ_w[1563:3124, ]
djw_s3 <- DJ_w[3125:4686, ]
```

```{r}
par(mfrow=c(1,3))

Acf(djd_s1[, 3], lag.max = 20, main = paste("ACF for DJ_d period 1"), ylim = c(-0.25, 0.25))
Acf(djd_s2[, 3], lag.max = 20, main = paste("ACF for DJ_d period 2"), ylim = c(-0.25, 0.25))
Acf(djd_s3[, 3], lag.max = 20, main = paste("ACF for DJ_d period 3"), ylim = c(-0.25, 0.25))

Acf(djw_s1[, 5], lag.max = 20, main = paste("ACF for DJ_w period 1"), ylim = c(-0.25, 0.25))
Acf(djw_s2[, 5], lag.max = 20, main = paste("ACF for DJ_w period 2"), ylim = c(-0.25, 0.25))
Acf(djw_s3[, 5], lag.max = 20, main = paste("ACF for DJ_w period 3"), ylim = c(-0.25, 0.25))
par(mfrow=c(1,1))
```

We cannot find anything that would indicate a structural break in the different time periods for either daily nor weekly data. 

We pursue to examine the non-overlapping 2 day and 2 weeks paired datasets. 

```{r}
length(twoday_ann) / 3 # 3140
length(twoweek_ann) / 3 # 781

dj_2d_p1 <- twoday_ann[1:3140]
dj_2d_p2 <- twoday_ann[3141:6280]
dj_2d_p3 <- twoday_ann[6281:9419]
dj_2w_p1 <- twoweek_ann[1:781]
dj_2w_p2 <- twoweek_ann[782:1562]
dj_2w_p3 <- twoweek_ann[1563:2343]
```

```{r}
par(mfrow=c(1,3))
Acf(dj_2d_p1, lag.max = 20, main = paste("ACF for DJ_d 2-day period 1"), ylim = c(-0.15, 0.15))
Acf(dj_2d_p2, lag.max = 20, main = paste("ACF for DJ_d 2-day period 2"), ylim = c(-0.15, 0.15))
Acf(dj_2d_p3, lag.max = 20, main = paste("ACF for DJ_d 2-day period 3"), ylim = c(-0.15, 0.15))

Acf(dj_2w_p1, lag.max = 20, main = paste("ACF for DJ_w 2-week period 1"), ylim = c(-0.15, 0.15))
Acf(dj_2w_p2, lag.max = 20, main = paste("ACF for DJ_w 2-week period 2"), ylim = c(-0.15, 0.15))
Acf(dj_2w_p3, lag.max = 20, main = paste("ACF for DJ_w 2-week period 3"), ylim = c(-0.15, 0.15))
par(mfrow=c(1,1))
```
For 2d data we observe lags 2,3,4, 11 and 15 are significant for period 1. For period 2 we observe lag 2 and 13 and for the last period we observe lags 5, 15 and 17 are significant. Given these findings we observe that the autocorrelation have a different structure from the other lags. These findings indicate that in the first period we observe some short-term autocorrelation and this structure is different from what we observe in the other two periods. 

For 2-week data and period 1 we only observe period 7 to be significant. For period 2 we observe lags 7, 9, 12, and 15 while for the last period we observe no lags to be significant. In the 2-week data we observe that period two has some autocorrelation around 7, 9 and 12 periods. This could indicate that the time periods 2 and 3 months before affect the price today and therefore some bimonthly and trimonthly autocorrelation. In the other two periods we observe no such findings.  

## Draw overall conclusions regarding asset return predictability based on this analysis.



# B. Testing for Return Predictability in Size Portfolios
Use the data set ”portcap_m” containing monthly returns of different U.S. stock portfolios built based on market capitalization. Using (cross-)autocorrelation functions, Ljung-Box statistics as well as variance ratio tests based on the complete time series as well as appropriate sub-periods you have to investigate the following issues

## 1. Is there a relationship between market capitalization and asset return predictability and does it also hold for higher aggregated returns?

We start by inspecting the data.
```{r}
portcap_m
```
We chose to analyze the top and low 10\%, however e.g. top and low 30\% would also be an appropriate choice. We divide the returns by 100 as they are in percentages in the original data. 

```{r}
lo10 <- portcap_m$Lo_10 / 100 
hi10 <- portcap_m$Hi_10 / 100 
```

We will assume that the data contains log returns, this is not clear based on the description but when plotting (simple `ts.plot()`) we see that the returns are centered around zero which is indicative of log returns.

```{r B1_ACF, echo=F}
par(mfrow=c(1,2))
p1 <- Acf(lo10, lag.max = 12, main = "Portfolio returns for low 10%")
p2 <- Acf(hi10, lag.max = 12, main = "Portfolio returns for top 10%.")
par(mfrow=c(1,1))
```
Looking at the ACF-plots above we see significant auto-correlations for both the low and top 10\%, this indicates asset return predictability.

```{r, include=F}
lagss <- c(6,12)
results <- matrix(NA, nrow = length(lagss), ncol = 4)
for(i in 1:length(lagss)){
lb1 <- LB(lo10,lag=lagss[i],ip=0)
lb2 <- LB(hi10,lag=lagss[i],ip=0)
results[i, 1] <- lb1$test
results[i, 2] <- lb1$pval
results[i, 3] <- lb2$test
results[i, 4] <- lb2$pval
}
round(results, 3)
```
\begin{table}[ht]
\centering
\caption{Ljung-Box Test Results for Portfolio returns for low and top 10\% with lag 6 and 12.}
\label{tab:LB_test}
\begin{tabular}{lcccc}
\toprule
\multirow{2}{*}{Lag} & \multicolumn{2}{c}{Low 10\%} & \multicolumn{2}{c}{Top 10\%} \\ 
\cmidrule(lr){2-3} \cmidrule(lr){4-5}
 & $Q_{LB}$ & p-value & $Q_{LB}$ & p-value \\ 
\midrule
6  & 58.034 & 0.000 & 23.452 & 0.001 \\ 
12  & 83.855 & 0.000 & 31.439  & 0.002 \\ 
\bottomrule
\end{tabular}
\end{table}

We can see that we reject the null of the first 6 and 12 autocorrelations being zero for both low 10\% and high 10\%, which indicates market predictability for both. Although we reject more strongly for low 10 \%, which indicates what market predictability is more prevalent for lower capitalized stocks than high.

```{r, include=F}
q <- c(2,4,8,16)
res_1 <- vector("list", length(q))
res_2 <- vector("list", length(q))

for (i in 1:length(q)) {
  res_1[[i]] <- c(VDR(lo10, iq = q[i]), list(q = q[i])) 
  res_2[[i]] <- c(VDR(hi10, iq = q[i]), list(q = q[i])) 
}
names(res_1) <- names(res_2) <- q
res_1
res_2
```
\begin{table}[ht]
\centering
\caption{The variance ratio test under RW1. Presented are variance distance, ratio, and p-values for Portfolio returns for low and top 10\%.}
\label{tab:VDRB2}
\begin{tabular}{c|cccc|cccc}
\hline
\multicolumn{1}{c|}{} &
\multicolumn{4}{c|}{Portfolio returns for low 10\%} & \multicolumn{4}{c}{Portfolio returns for top 10\%} \\ \hline
$q$ & VD & p-value & VR & p-value & VD & p-value & VR & p-value \\ \hline
2 & 6.684 & 0.000 & 6.684 & 0.000 & 2.218 & 0.027 & 2.218 & 0.027 \\
4 & 4.656 & 0.000 & 4.656 & 0.000 & 0.690 & 0.490 & 0.690 & 0.490 \\
8 & 1.715 & 0.086 & 1.715 & 0.086 & 0.764 & 0.445 & 0.764 & 0.445 \\
16 & 1.611 & 0.107 & 1.611 & 0.107 & 1.479 & 0.139 & 1.479 & 0.139 \\
\hline
\end{tabular}
\end{table}


We observe that for Lo_10 portfolio returns the test statistic from VGD is significant for q 2 and 4 which would suggest that these are not random walks. For q 8 and 16 we cannot reject null and therefore have no evidence to prove that they are not random walks.

For Hi_10 portfolio returns there is some evidence that is contradictory. The theory suggests that the biggest companies should be random walk however our finding when q is 2 is that we can reject the null of random walk. For this reason, we assume that Hi_10 companies are predictable in the very few successive time periods but not longer.

Results from previous studies show that for portfolios of large size companies we should not see any significant autocorrelations, and for portfolios of small-size companies we should see significantly positive autocorrelations. Our results are contradictory, we actually see significant autocorrelations for large size companies. For small-size companies portfolio we do see significant positive autocorrelations, but we also see 1 small spike that is negative, but it perhaps that one can be attributed to chance, as it is not extremely large spike (lag 3).

We can conclude that we see evidence for asset return predictability for both portfolios of large and small companies, but we do not observe what is expected from previous studies.

Next we want to check if these results hold for higher aggregated returns. We will use two-month returns:

```{r, echo=F}
onemonth_lo10 <- lo10
onemonth_hi10 <- hi10

twomonth_lo10 <- onemonth_lo10[seq(1, length(onemonth_lo10), by = 2)] + onemonth_lo10[seq(2, length(onemonth_lo10), by = 2)]
twomonth_lo10_ann <- twomonth_lo10/2

twomonth_hi10 <- onemonth_hi10[seq(1, length(onemonth_hi10), by = 2)] + onemonth_hi10[seq(2, length(onemonth_hi10), by = 2)]
twomonth_hi10_ann <- twomonth_hi10/2
```
```{r B1_ACF2, echo=F, warning=F, error=F}
par(mfrow=c(1,2))
p1 <- Acf(twomonth_lo10_ann, lag.max = 12, main = "Portfolio returns for low 10%")
p2 <- Acf(twomonth_hi10_ann, lag.max = 12, main = "Portfolio returns for top 10%.")
par(mfrow=c(1,1))
```
As we can see in the ACF-plots above, there are several significant auto-correlations for the low 10\%, however, for the top 10\% there is only one significant auto-correlation at lag 7. This is an indication that there is likely asset return predictability in the low 10\% but less likely in the top 10\%.

Performing the Ljung-Box test:
```{r, include=F}
lagss <- c(3,6)
results <- matrix(NA, nrow = length(lagss), ncol = 4)
for(i in 1:length(lagss)){
lb1 <- LB(twomonth_lo10_ann,lag=lagss[i],ip=0)
lb2 <- LB(twomonth_hi10_ann,lag=lagss[i],ip=0)
results[i, 1] <- lb1$test
results[i, 2] <- lb1$pval
results[i, 3] <- lb2$test
results[i, 4] <- lb2$pval
}
round(results, 3)
```
\begin{table}[ht]
\centering
\caption{Ljung-Box Test Results for two month aggregated portfolio returns for low and top 10\% with lag 3 and 6.}
\label{tab:LB_test}
\begin{tabular}{lcccc}
\toprule
\multirow{2}{*}{Lag} & \multicolumn{2}{c}{Low 10\%} & \multicolumn{2}{c}{Top 10\%} \\ 
\cmidrule(lr){2-3} \cmidrule(lr){4-5}
 & $Q_{LB}$ & p-value & $Q_{LB}$ & p-value \\ 
\midrule
3  & 8.042 & 0.045 & 1.883 & 0.597 \\ 
6  & 17.380 & 0.008 & 7.232  & 0.300 \\ 
\bottomrule
\end{tabular}
\end{table}
What we see in table \ref{tab:LB_test} is that the auto-correlations for lags 3 and 6 are significant at $\alpha=0.05$ for the two month aggregated portfolio returns for low 10\%, but for top 10\% the auto-correlations are not significant. This indicates that for two month aggregated returns, asset return predictability only holds for the low 10\%.

Looking at the variance ratio test:
```{r, echo=F}
q <- c(2,4,8,16)
res_lo <- matrix(NA, nrow=4, ncol=4)
res_hi <- matrix(NA, nrow=4, ncol=4)

for (i in 1:length(q)){
res_1 <- VDR(vr=twomonth_lo10_ann,iq=q[i])
res_2 <- VDR(vr=twomonth_hi10_ann,iq=q[i])
res_lo[i,1] <- res_1$VD
res_lo[i,2] <- res_1$RW1_p_VD
res_lo[i,3] <- res_1$VR
res_lo[i,4] <- res_1$RW1_p_VR
res_hi[i,1] <- res_2$VD
res_hi[i,2] <- res_2$RW1_p_VD
res_hi[i,3] <- res_2$VR
res_hi[i,4] <- res_2$RW1_p_VR
}
cbind(round(res_lo,3),round(res_hi,3))
```
\begin{table}[ht]
\centering
\caption{The variance ratio test under RW1. Presented are variance distance, ratio, and p-values for Portfolio returns for low and top 10\%.}
\label{tab:VDRB22}
\begin{tabular}{c|cccc|cccc}
\hline
\multicolumn{1}{c|}{} &
\multicolumn{4}{c|}{Portfolio returns for low 10\%} & \multicolumn{4}{c}{Portfolio returns for top 10\%} \\ \hline
$q$ & VD & p-value & VR & p-value & VD & p-value & VR & p-value \\ \hline
2  & 0.772 & 0.440 & 0.772 & 0.440 & -0.702 & 0.483 & -0.702 & 0.483 \\
4  & -0.952 & 0.341 & -0.952 & 0.341 & -0.031 & 0.975 & -0.031 & 0.975 \\
8  & -0.370 & 0.712 & -0.370 & 0.712 & 0.899 & 0.369 & 0.899 & 0.369 \\
16 & -0.695 & 0.487 & -0.695 & 0.487 & 0.390 & 0.697 & 0.390 & 0.697 \\
\hline
\end{tabular}
\end{table}
In table \ref{tab:VDRB22} we see the results from the variance ratio test for the two month aggregated portfolio returns. Here we see the results that we cannot reject the null, contradicting the results from the ACF-plots and Ljung-Box test. This makes it more difficult to come to a conclusion, but we believe based on the ACF and Ljung-Box test that there is likely asset return predictability in the low 10\% but not in the top 10\% for the two month aggregated returns.


## 2. Is this relationship stable over time?


Let us split up it in three time periods.
```{r, echo=F}
lo10p1 <- portcap_m$Lo_10[1:314] #period 1
lo10p2 <- portcap_m$Lo_10[315:628] #period 2
lo10p3 <- portcap_m$Lo_10[629:942] #period 3

length(lo10p1)
length(lo10p2)
length(lo10p3)

#hi10p1 <- portcap_m$Hi_10[1:314] #period 1
#hi10p2 <- portcap_m$Hi_10[315:628] #period 2
#hi10p3 <- portcap_m$Hi_10[629:942] #period 3

par(mfrow=c(1,3))

Acf(lo10p1, lag.max = 20, main = paste("ACF for lo_10 period 1"), ylim = c(-0.25, 0.25))
Acf(lo10p2, lag.max = 20, main = paste("ACF for lo_10 period 2"), ylim = c(-0.25, 0.25))
Acf(lo10p3, lag.max = 20, main = paste("ACF for lo_10 period 3"), ylim = c(-0.25, 0.25))

Acf(hi10p1, lag.max = 20, main = paste("ACF for hi_10 period 1"), ylim = c(-0.25, 0.25))
Acf(hi10p2, lag.max = 20, main = paste("ACF for hi_10 period 2"), ylim = c(-0.25, 0.25))
Acf(hi10p3, lag.max = 20, main = paste("ACF for hi_10 period 3"), ylim = c(-0.25, 0.25))
par(mfrow=c(1,1))

#LB(lo10p1,lag=12,ip=0)
#LB(hi10p1,lag=12,ip=0)

#LB(lo10p2,lag=12,ip=0)
#LB(hi10p2,lag=12,ip=0)

#LB(lo10p3,lag=12,ip=0)
#LB(hi10p3,lag=12,ip=0)
```
Looking at the ACF plots above, we see significant spikes for the lo 10\% for all three time periods. For the top 10\% we also see significant spikes for all periods, however the results from period two and three are somewhat inconclusive with autocorrelations which are not as significant compared to the lowest 10\%. Based on this, we believe that there is likely asset return predictability for the low 10\% for all periods while we are less confident for the top 10\%.

\begin{table}[ht]
\centering
\caption{Ljung-Box Test Results for Different Portfolios}
\begin{tabular}{|c|c|c|}
\hline
\textbf{Portfolio} & \textbf{Test Statistic} & \textbf{p-value} \\ \hline
Lo10 (Period 1) & 37.070 & 0.000 \\ \hline
Hi10 (Period 1) & 26.537 & 0.009 \\ \hline
Lo10 (Period 2) & 36.781 & 0.000 \\ \hline
Hi10 (Period 2) & 18.119 & 0.112 \\ \hline
Lo10 (Period 3) & 34.388 & 0.001 \\ \hline
Hi10 (Period 3) & 13.472 & 0.336 \\ \hline
\end{tabular}
\label{tab:LB_test_results}
\end{table}


## 3. Are there significant cross-autocorrelations between different size portfolios? 

```{r, echo=F}
res <- ccf(lo10, hi10, lag.max = 20)
```
\begin{tabular}{rr}
\toprule
Lag & ACF\\
\midrule
-20 & -0.0995100\\
-19 & -0.0359168\\
-18 & 0.0397203\\
-17 & 0.1048444\\
-16 & -0.0088606\\
\addlinespace
-15 & 0.0385249\\
-14 & -0.0876180\\
-13 & -0.0615885\\
-12 & -0.0153525\\
-11 & 0.0055631\\
\addlinespace
-10 & 0.0296554\\
-9 & 0.0808252\\
-8 & -0.0010983\\
-7 & 0.0038968\\
-6 & -0.0223456\\
\addlinespace
-5 & 0.0180234\\
-4 & 0.0111506\\
-3 & -0.0707419\\
-2 & -0.0483765\\
-1 & 0.0793763\\
\addlinespace
0 & 0.6985677\\
1 & 0.2225634\\
2 & 0.0221419\\
3 & -0.1071838\\
4 & -0.0713023\\
\addlinespace
5 & 0.0078996\\
6 & -0.0298914\\
7 & -0.0028170\\
8 & -0.0083827\\
9 & 0.1197998\\
\addlinespace
10 & 0.0428947\\
11 & -0.0594163\\
12 & -0.0369711\\
13 & -0.0958468\\
14 & -0.0597143\\
\addlinespace
15 & -0.0197416\\
16 & -0.1052750\\
17 & 0.0421748\\
18 & -0.0137750\\
19 & 0.0160187\\
\addlinespace
20 & -0.1067921\\
\bottomrule
\end{tabular}

When negative lag, it means that the returns of Lo_10 is compared to the future returns of the Hi_10. When positive lags it means that the Hi_10 is compared to the future returns of the Lo_10. We observe significant lags both for negative and positive lags. Furthermore, the lags are in both directions, both positive and negative cross-autocorrelations and for this reason it is very hard to draw one general conclusion. One thing that is evident is however the significant lag 1, which means that Hi_10 is correlated with short-term future returns of Lo_10, supporting the theory that big companies leads and small companies lags. We will continue by dividing it into subperiods and examining the autocorrelations again. Above is a table of the magnitudes. 
```{r, echo=F}
res_1 <- ccf(lo10p1, hi10p1, lag.max = 20)
res_2 <- ccf(lo10p2, hi10p2, lag.max = 20)
res_3 <- ccf(lo10p3, hi10p3, lag.max = 20)
```
For period 1, it is evident that there are more significant positive lags than negative, supporting the theory of leading large companies. In the second period we observe no significant negative lags but three significant positive lags which are at lags 1, 3, and 7. Finally, for period three we observe two significant negative lags (8, 12) and four significant positive lags (1, 4, 16, and 18). These findings suggest that lag 1 is always positive and significant which supports the theory of leading large companies. Following is a table of the magnitudes. 

\begin{tabular}{rrrr}
\toprule
Lag & ACF P1 & ACF P2 & ACF P3\\
\midrule
-20 & -0.1103998 & -0.0432523 & -0.1045049\\
-19 & -0.0102827 & -0.0514065 & -0.1059982\\
-18 & 0.0823519 & -0.0545906 & -0.0286165\\
-17 & 0.1391339 & -0.0064733 & 0.0639247\\
-16 & -0.0195983 & -0.0072937 & 0.0123273\\
\addlinespace
-15 & 0.0463637 & 0.1083565 & -0.0418253\\
-14 & -0.1058507 & -0.0831579 & -0.0202578\\
-13 & -0.0522825 & -0.0705355 & -0.0902624\\
-12 & -0.0083745 & 0.0499713 & -0.1279071\\
-11 & 0.0080956 & 0.0387980 & -0.0381943\\
\addlinespace
-10 & 0.0220173 & -0.0009402 & 0.1021607\\
-9 & 0.1194956 & 0.0873122 & -0.0638926\\
-8 & 0.0517223 & -0.0833388 & -0.1374145\\
-7 & 0.0131612 & -0.0490651 & 0.0050515\\
-6 & -0.0226866 & -0.0794861 & 0.0272519\\
\addlinespace
-5 & 0.0167546 & 0.0008242 & 0.0475835\\
-4 & 0.0192456 & 0.0520687 & -0.0649172\\
-3 & -0.0892614 & 0.0246773 & -0.0842593\\
-2 & -0.0445604 & -0.0149691 & -0.0969952\\
-1 & 0.1126604 & 0.0027913 & 0.0331768\\
\addlinespace
0 & 0.7619358 & 0.6605027 & 0.5878333\\
1 & 0.2458573 & 0.2153915 & 0.1740160\\
2 & 0.0244658 & 0.0315184 & 0.0100482\\
3 & -0.1949702 & 0.1225646 & 0.0348512\\
4 & -0.0847712 & 0.0278292 & -0.1177156\\
\addlinespace
5 & 0.0111564 & 0.0160018 & -0.0058055\\
6 & -0.0304142 & -0.0544791 & -0.0089222\\
7 & 0.0271244 & -0.1163203 & -0.0233280\\
8 & 0.0096359 & -0.0703728 & -0.0319809\\
9 & 0.1939537 & 0.0492911 & -0.0938559\\
\addlinespace
10 & 0.0829907 & -0.0980722 & 0.0299945\\
11 & -0.0846743 & -0.0158970 & -0.0123815\\
12 & -0.0570957 & 0.0163617 & -0.0174782\\
13 & -0.1350653 & 0.0320444 & -0.0582166\\
14 & -0.0649635 & -0.0624044 & -0.0266399\\
\addlinespace
15 & -0.0061131 & 0.0113940 & -0.0697472\\
16 & -0.1176521 & -0.0693399 & -0.1257395\\
17 & 0.0724068 & -0.0182994 & -0.0346438\\
18 & 0.0253502 & -0.0172441 & -0.1513245\\
19 & 0.0467810 & -0.1017195 & 0.0104923\\
\addlinespace
20 & -0.1534308 & -0.0414355 & 0.0240477\\
\bottomrule
\end{tabular}


Finally, we conduct a Ljung-Box test to test if the cross autocorrelation are significant. 
```{r, include=F}
LB(res$acf, lag = 12, ip = 0)
LB(res_1$acf, lag = 12, ip = 0)
LB(res_2$acf, lag = 12, ip = 0)
LB(res_3$acf, lag = 12, ip = 0)
```
\begin{table}[ht]
\centering
\caption{Cross-Correlation Function (CCF) Ljung-Box Test Results with lag 12.}
\begin{tabular}{|c|c|c|}
\hline
\textbf{Period} & \textbf{Test Statistic} & \textbf{p-value} \\ \hline
Overall         & 15.029                  & 0.240            \\ \hline
Period 1        & 25.202                  & 0.014            \\ \hline
Period 2        & 12.386                  & 0.415            \\ \hline
Period 3        & 12.216                  & 0.428            \\ \hline
\end{tabular}
\label{tab:CCF_LB_test_results}
\end{table}

We observe that there are no significant test statistics except for the first period. We also found evidence that the first positive lag would almost always be significant so we test only one lag also. 

```{r}
LB(res$acf, lag = 1, ip = 0)
LB(res_1$acf, lag = 1, ip = 0)
LB(res_2$acf, lag = 1, ip = 0)
LB(res_3$acf, lag = 1, ip = 0)
```
\begin{table}[ht]
\centering
\caption{Ljung-Box Test Results at Lag 1}
\begin{tabular}{lcc}
\hline
\textbf{Series} & \textbf{Test Statistic} & \textbf{p-value} \\
\hline
Full Sample     & 5.306 & 0.021 \\
Period 1     & 5.190 & 0.023 \\
Period 2    & 3.269 & 0.071 \\
Period 3     & 4.241 & 0.039 \\
\hline
\end{tabular}
\label{tab:lb_lag1}
\end{table}

In this case, all periods except for the third are significant at a 5\% level, the third is significant at 10\% level. This concludes and confirms the theory that large companies are leading, at least in short-term. 

## 4. Can you confirm the results of Campbell/Lo/MacKinlay (1997) that high-cap stocks lead small-cap stocks? How stable is this result over time?

Yes, we can confirm the results of Campbell/Lo/Mackinlay (1997) and the theory that high-cap stocks lead small-cap stocks, at least in the short term. The results are stable over time on a 10\% level and on a 5\% level on the whole dataset and in period 1 and 3. 


