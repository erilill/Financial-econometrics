---
title: "Report for PS 2"
author:
- Mark Becker, Erik Lillrank & Vilim Nedic
date: ''
output:
  pdf_document:
    keep_tex: true
  df_print: kable
  html_document:
    df_print: paged
  word_document: default
header-includes:
  - \usepackage{float}
  - \usepackage{booktabs}
  - \usepackage{multirow}
  - \usepackage{caption}
  - \usepackage{subcaption}
  - \usepackage{adjustbox}
toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(FE)
library(knitr)
library(forecast)
library(patchwork)
data("DJ_w")
data("DJ_d")
data("portcap_m")
```

# A. Testing for asset return predicatability.
Use the data sets ”DJ_d” (Dow Jones daily) and ”DJ_w” (Dow Jones weekly) containing daily and weekly observations of the Dow Jones index. In the following, you have to test for asset return predictability based on autocorrelation functions, Ljung-Box statistics as well as variance ratio tests.

## 1. Do you find significant evidence for asset return predictability on the daily and weekly level?

For this question, we will use autocorrelation functions, Lung-Box statistics and variance ratio tests in order to gage whether there is significant evidence for asset return predictability.

ACF: 
```{r A1_ACF, echo=F}
par(mfrow=c(1,2))
p1 <- Acf(DJ_d$r_Dow_Jones, lag.max = 20, main = "Dow Jones daily")
p2 <- Acf(DJ_w$r_close, lag.max = 20, main = "Dow Jones weekly")
par(mfrow=c(1,1))
```
Above you see the ACF plots for the Dow Jones daily and weekly data with 20 lags. For easier interpretation, lag 0 has been omitted.

What we see from the plots is that we have large spikes for the first two lags in the daily data, with some moderately large spikes for further lags. For the weekly data we do not see any highly significant auto-correlations. 

We see significant auto-correlations for the first few lags in the daily data, this is an indication of asset return predictability, at least short-term.


Ljung-Box test:

```{r A1_LB, include=F}
LB <- function(vx,lag,ip){
  tmp = acf(vx,lag.max=lag,plot=F)$acf
  tmp = tmp[2:(lag+1)]**2
  test = sum(tmp/(length(vx)-1:lag))*length(vx)*(length(vx)+2)
  return(list(test=test, pval=1-pchisq(test,df=lag-ip)))
}

gridsearch <- function(data, lag){
  results <- matrix(NA, nrow=length(lag), ncol = 2)
  for (j in 1:length(lag)){
      lagj <- lag[j]
      results[j,1]<-LB(vx=data,lag=lagj,ip=0)$test
      results[j,2]<-LB(vx=data,lag=lagj,ip=0)$pval
    }
  return(results)
}
lag = c(1:20)
t1 <- gridsearch(DJ_d$r_Dow_Jones, lag)
t2 <- gridsearch(DJ_w$r_close, lag)
cbind(t1,t2)
```
\begin{table}[ht]
\centering
\caption{Ljung-Box Test Statistics for Dow Jones Daily and Weekly Returns (Rounded to 3 Decimal Places)}
\label{tab1:LB}
\begin{tabular}{lcccc}
\toprule
\multirow{2}{*}{Lag} & \multicolumn{2}{c}{Dow Jones Daily} & \multicolumn{2}{c}{Dow Jones Weekly} \\ 
\cmidrule(lr){2-3} \cmidrule(lr){4-5}
 & $Q_{LB}$ & p-value & $Q_{LB}$ & p-value \\ 
\midrule
1  & 179.105 & 0.000 & 0.918 & 0.338 \\ 
2  & 287.650 & 0.000 & 0.923 & 0.630 \\ 
3  & 290.524 & 0.000 & 1.454 & 0.693 \\ 
4  & 322.834 & 0.000 & 2.255 & 0.689 \\ 
5  & 329.899 & 0.000 & 5.144 & 0.399 \\ 
6  & 348.859 & 0.000 & 8.320 & 0.216 \\ 
7  & 353.048 & 0.000 & 12.379 & 0.089 \\ 
8  & 365.251 & 0.000 & 13.268 & 0.103 \\ 
9  & 366.429 & 0.000 & 13.475 & 0.142 \\ 
10 & 371.600 & 0.000 & 13.592 & 0.192 \\ 
11 & 371.600 & 0.000 & 13.611 & 0.255 \\ 
12 & 372.899 & 0.000 & 14.025 & 0.299 \\ 
13 & 374.639 & 0.000 & 14.795 & 0.320 \\ 
14 & 378.137 & 0.000 & 19.685 & 0.140 \\ 
15 & 379.141 & 0.000 & 19.946 & 0.174 \\ 
16 & 379.994 & 0.000 & 20.387 & 0.203 \\ 
17 & 384.854 & 0.000 & 21.244 & 0.216 \\ 
18 & 385.707 & 0.000 & 22.535 & 0.209 \\ 
19 & 387.883 & 0.000 & 22.543 & 0.258 \\ 
20 & 388.925 & 0.000 & 23.320 & 0.273 \\ 
\bottomrule
\end{tabular}
\end{table}

We see from table \ref{tab1:LB} that the p-values for all 20 lags are zero for the daily data, meaning that we have significant auto-correlations. This is an indication that there is potentially asset return predictability in the daily data. For the weekly series, all p-values are above 0.05. For lag 7, $\hat{p}\leq 0.1$, but the p-values for all other lags are above $\alpha=0.1$. Using $\alpha=0.05$ we reject the null that there is auto-correlation, indicating that there is no prevalence of asset return predictions. 

Variance ratio test:

```{r A1_VR, echo=F}
VDR <- function(vr,iq){
  iTT = length(vr)
  im = floor(iTT/iq)
  iT = im*iq
  
  rr = vr[1:iT]
  mu = mean(rr)
  sa2 = var(rr)
  
  arr = NULL
  for(iter in 1:(iT-iq+1))
    arr = c(arr,sum(rr[iter:(iter+iq-1)]))
  
  sc2 = sum((arr-mu*iq)**2)/iq/(iT-iq+1)/(1-(1/im))
  
  VD = sc2 - sa2
  VR = sc2/sa2
  tmp = sqrt(2*(2*iq-1)*(iq-1)/3/iq)
  
  VD = VD*sqrt(iT)/sa2/tmp
  VR = (VR-1)*sqrt(iT)/tmp
  
  RW1_p_VD <- 2*(1-pnorm(abs(VD)))
  RW1_p_VR <- 2*(1-pnorm(abs(VR)))
  
  return(list(VD=VD, VR=VR, RW1_p_VD=RW1_p_VD, RW1_p_VR=RW1_p_VR))
}
q <- c(2,4,8,16)
res_d <- matrix(NA, nrow=4, ncol=4)
res_w <- matrix(NA, nrow=4, ncol=4)

for (i in 1:length(q)){
res_1 <- VDR(vr=DJ_d$r_Dow_Jones,iq=q[i])
res_2 <- VDR(vr=DJ_w$r_close,iq=q[i])
res_d[i,1] <- res_1$VD
res_d[i,2] <- res_1$RW1_p_VD
res_d[i,3] <- res_1$VR
res_d[i,4] <- res_1$RW1_p_VR
res_w[i,1] <- res_2$VD
res_w[i,2] <- res_2$RW1_p_VD
res_w[i,3] <- res_2$VR
res_w[i,4] <- res_2$RW1_p_VR
}
round(res_d,3)
round(res_w,3)
```

## 2. What about the asset return predictability of two-day and two-week returns? What about the higher aggregated returns?

```{r A1_VR, echo=F}
oneday <- DJ_d$r_Dow_Jones
oneday <- oneday[-1]
oneweek <- DJ_w$r_close

twoday <- oneday[seq(1, length(oneday), by = 2)] + oneday[seq(2, length(oneday), by = 2)]
twoday_ann <- twoday/2


twoweek <- oneweek[seq(1, length(oneweek), by = 2)] + oneweek[seq(2, length(oneweek), by = 2)]
twoweek_ann <- twoweek/2

par(mfrow=c(1,2))
ts.plot(twoday_ann)
ts.plot(twoweek_ann)
par(mfrow=c(1,1))

par(mfrow=c(1,2))
p3 <- Acf(twoday_ann, lag.max = 20, main = "DJIA two day ann. log returns")
p4 <- Acf(twoweek_ann, lag.max = 20, main = "DJIA two-week ann. log returns")
par(mfrow=c(1,1))
```

Above we can see ACF plots for the annualized two-day and two-week log returns with 20 lags. For easier interpretation, lag 0 has been omitted.

What we see from the first ACF plot for the two-day is that we have large significant spikes at lag 2 and 4, 11, 15 and 17. For the two-week data we see two significant spikes at 12 and 15, but they are not very large.

So for two-day we see significant auto-correlations for many lags, and quite far out also, this is an indication of asset return predictability. For two-week we see significant auto-correlations for two lags quite far out, this is an indication of asset return predictability.

But realistically using more than 10 lags for two week data does not make much sense. It is too many lags out for two-weekly data. So I think we can reasonably disregard this finding and say that it is due to randomness/noise. But for two-day we for sure see strong signs of market predictability.

Lets do Ljung Box tests, but restrict two-week to have lag=10.
```{r}
LB(twoday_ann, lag=20, ip=0)

LB(twoday_ann, lag=10, ip=0)
```
So the result tells us that for the two-day returns, that we strongly reject $(\alpha=0.01)$ the null of the first 20 autocorrelations being all zero. For the two-week returns, we strongly reject $(\alpha=0.01)$ the null of the first 10 autocorrelations being zero. The latter result is quite suprising since we did not see significant spikes at 10 lags or earlier for the two-week. These results strongly indicate that there is prevalence of asset return predictability for both two-day and two-week returns.

## 3. Divide the sample into appropriate sub-periods and analyze whether you find evidence of an increasing market efficiency over time.

```{r Q 1.3 Splitting the data}
# Dividing the data set into three equally sized time windows 
djd_s1 <- DJ_d[1:6280, ]
djd_s2 <- DJ_d[6281:12560, ]
djd_s3 <- DJ_d[12561:18839, ]
djw_s1 <- DJ_w[1:1562, ]
djw_s2 <- DJ_w[1563:3124, ]
djw_s3 <- DJ_w[3125:4686, ]
```

```{r Q 1.3 ACF}
par(mfrow=c(1,3))
acf(djd_s1[, 3], lag.max = 20, main = paste("ACF for DJ_d period 1"))
acf(djd_s2[, 3], lag.max = 20, main = paste("ACF for DJ_d period 2"))
acf(djd_s3[, 3], lag.max = 20, main = paste("ACF for DJ_d period 3"))

acf(djw_s1[, 5], lag.max = 20, main = paste("ACF for DJ_w period 1"))
acf(djw_s2[, 5], lag.max = 20, main = paste("ACF for DJ_w period 2"))
acf(djw_s3[, 5], lag.max = 20, main = paste("ACF for DJ_w period 3"))
par(mfrow=c(1,1))
```

We cannot find anything that would indicate a structural break in the different time periods for either daily nor weekly data. 

We pursue to examine the non-overlapping 2 day and 2 weeks paired datasets. 




## Draw overall conclusions regarding asset return predictability based on this analysis.


# B. Testing for Return Predictability in Size Portfolios

## 1. Is there a relationship between market capitalization and asset return predictability and does it also hold for higher aggregated returns?

## 2. Is this relationship stable over time?

## 3. Are there significant cross-autocorrelations between different size portfolios?

## 4. Can you confirm the results of Campbell/Lo/MacKinlay (1997) that high-cap stocks lead small-cap stocks? How stable is this result over time?